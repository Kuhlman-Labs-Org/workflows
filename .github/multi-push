name: Multi-Remote Push

on:
  push:
    paths:
      - 'workflows/**'

jobs:
  push-to-remotes:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install PyYAML
      run: pip install pyyaml

    - name: Read config.yaml
      id: read-config
      run: |
        import yaml
        with open('config.yaml', 'r') as file:
          config = yaml.safe_load(file)
        print(f"::set-output name=orgs::{config['orgs']}")

    - name: Push to remotes
      env:
        GITHUB_TOKEN: ${{ secrets.SYNC_TOKEN }}
      run: |
        orgs=${{ steps.read-config.outputs.orgs }}
        IFS=',' read -r -a org_array <<< "$orgs"
        for org in "${org_array[@]}"
        do
          remote_url="https://x-access-token:${GITHUB_TOKEN}@github.com/${org}/$(basename $GITHUB_REPOSITORY).git"
          git remote add $org $remote_url
          git push $org --all -f
          git push $org --tags -f
        done
